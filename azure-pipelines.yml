trigger:
  branches:
    include:
      - deployment

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: GCloud-Variables
  - name: IMAGE_NAME
    value: 'gcr.io/$(GCLOUD_PROJECT_ID)/portfolio-ssr'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Install Node.js'

  - script: |
      npm ci --legacy-peer-deps
    displayName: 'Install dependencies'

  - script: |
      npm run build
    displayName: 'Build Angular with SSR'

  - script: |
      echo '$(GCLOUD_SERVICE_KEY)' | base64 -d > ${HOME}/gcloud-key.json
      gcloud auth activate-service-account --key-file ${HOME}/gcloud-key.json
      gcloud config set project $(GCLOUD_PROJECT_ID)
    displayName: 'Authenticate with Google Cloud'

  - script: |
      gcloud builds submit --tag $(IMAGE_NAME)
    displayName: 'Build and Push Docker Image'

  - script: |
      gcloud run deploy portfolio-ssr \
        --image $(IMAGE_NAME) \
        --platform managed \
        --region us-central1 \
        --allow-unauthenticated \
        --min-instances 0 \
        --max-instances 2 \
        --memory 512Mi \
        --cpu 1 \
        --timeout 60
    displayName: 'Deploy to Cloud Run'